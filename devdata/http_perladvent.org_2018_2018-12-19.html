<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.113" />
    <link rel="alternate" title="Perl Advent Calendar 2018 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2018.css" type="text/css" />
    <title>
Perl Advent Calendar 2018 - 
Cute Christmas Animals

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2018</a></h1>
        </div>

        <p id="tagline">2018 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Cute Christmas Animals</h1>
<div class='subtitle'>Mojo::Promise - 2018-12-19</div>

<div class='pod'><p>State sponsored hacking. Influencing foreign elections. Crypto currency ponzi schemes. Have we forgotten what the Internet is really for? <i>Looking at cute pictures of cats</i>.</p>

<p><center><img src="https://i.imgur.com/XgJetkM.jpg" width="500"></center>

</p>



<p>With all the craziness that&#39;s going on online, it feels good to take a break from it all and just look at pictures of cats for a bit. And you know what can help with that? Yep...Perl!</p>

<p>Let&#39;s write a quick Perl script to get us some <i>Christmas</i> cat pictures to look at by accessing Imgur&#39;s REST API.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Mojo::UserAgent</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mojo::Template</span><span class="structure">;</span><br /><br /><span class="comment"># get your own client id at https://api.imgur.com/oauth2/addclient<br /></span><span class="keyword">my</span> <span class="symbol">$CLIENT_ID</span> <span class="operator">=</span> <span class="single">'&lt;&lt;REDACTED&gt;&gt;'</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$results</span> <span class="operator">=</span> <span class="word">Mojo::UserAgent</span><span class="operator">-&gt;</span><span class="word">new</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Mojo::URL</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="single">'https://api.imgur.com'</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">path</span><span class="structure">(</span><span class="single">'/3/gallery/search'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">query</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">q_all</span> <span class="operator">=&gt;</span> <span class="single">'christmas cat'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">q_not</span> <span class="operator">=&gt;</span> <span class="single">'tag:&quot;secret santa&quot;'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">{</span> <span class="word">Authorization</span> <span class="operator">=&gt;</span> <span class="double">&quot;Client-ID $CLIENT_ID&quot;</span><span class="structure">}</span><span class="operator">,</span><br /><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">result</span><span class="operator">-&gt;</span><span class="word">json</span><span class="structure">(</span><span class="single">'/data'</span><span class="structure">);</span><br /><br /><span class="keyword">my</span> <span class="symbol">$mt</span> <span class="operator">=</span> <span class="word">Mojo::Template</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">;</span><br /><span class="word">print</span> <span class="symbol">$mt</span><span class="operator">-&gt;</span><span class="word">vars</span><span class="structure">(</span><span class="number">1</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">render</span><span class="structure">(</span><span class="heredoc">&lt;&lt;'HTML'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">data</span> <span class="operator">=&gt;</span> <span class="symbol">$results</span> <span class="structure">});</span><br /><span class="heredoc_content">&lt;html&gt;<br />&lt;body&gt;<br />% for my $post (@{ $data }) {<br />&lt;h2&gt;&lt;%= $post-&gt;{title} %&gt;&lt;/h2&gt;<br />%   for my $image (@{ $post-&gt;{images} }) {<br />&lt;img src=&quot;&lt;%= $image-&gt;{link} %&gt;&quot; width=&quot;400&quot;&gt;<br />&lt;p&gt;&lt;%= $image-&gt;{description} || &quot;&quot;%&gt;&lt;/p&gt;<br />%   }<br />% }<br />&lt;/body&gt;<br />&lt;/html&gt;<br /></span><span class="heredoc_terminator">HTML<br /></span></code><br />&nbsp;</td></table>

<p>Rather than using LWP::UserAgent and URI (like in <a href="http://perladvent.org/2018/2018-12-17.html">the Spotify REST API example</a>) we&#39;re using Mojolicious&#39;s <a href="https://metacpan.org/module/Mojo::UserAgent">Mojo::UserAgent</a> and <a href="https://metacpan.org/module/Mojo::URL">Mojo::URL</a> to make the request and build the URL. Mojolicious&#39;s interface is a little more compact, allowing us to easily do things like chain method calls as we&#39;re building the URL object (with each mutating call returning the object itself again) so we can construct it directly inside our user agent method call. With Mojolicious there&#39;s no need to explicitly create a request object in order to simply set a header. The JSON parsing is also handled as part of the Mojolicious framework with a call to the <code>json</code> method rather than needing to make use of a seperate <code>decode_json</code> function call - in addition, we&#39;re passing it a <a href="https://tools.ietf.org/html/rfc6901">JSON Pointer</a> to indicate which <i>bit</i> of the JSON data structure it should return.</p>

<p>All in all, it&#39;s pretty neat having to write less code. But the real advantages in using Mojo to do this comes when you want to start doing concurrency...</p>

<h3 id="What-about-the-Dogs">What about the Dogs?</h3>

<p>What you say? You&#39;re a <i>Dog</i> person? Well, me too. Our house is blessed by not only two cute cats but a wonderful basset hound (who fight each other like cats and dogs...but I digress.) So, yep, I like looking at pictures of dogs too. Maybe we can adjust our script to show pictures of Christmas dogs as well?</p>

<p><center><img src="https://i.imgur.com/gGiXuyv.jpg" width="500"></center>

</p>



<p>What I really want to do is alternate posts from the cat search with posts from the dog search. But to do that I need to make two API calls, and I&#39;m an <i>incredibly</i> impatient person when it comes to getting my cute animal fix. I don&#39;t want to wait for my cute Christmas cats API call to return before making my cute Christmas dogs API call. What I want to do is make them at <i>the same time</i>.</p>

<p>Instead of returning a result we could have Mojo::UserAgent use the Mojo IO loop to fire a callback when it&#39;s complete. This is achieved by passing an anonymous subroutine as an argument:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="symbol">$ua</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Mojo::URL</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="single">'https://api.imgur.com'</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">path</span><span class="structure">(</span><span class="single">'/3/gallery/search'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">query</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">q_all</span> <span class="operator">=&gt;</span> <span class="single">'christmas $animal'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">q_not</span> <span class="operator">=&gt;</span> <span class="single">'tag:&quot;secret santa&quot;'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">{</span> <span class="word">Authorization</span> <span class="operator">=&gt;</span> <span class="double">&quot;Client-ID $CLIENT_ID&quot;</span><span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$ua</span><span class="operator">,</span> <span class="symbol">$tx</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="word">STDERR</span> <span class="double">&quot;Got data back for $animal...\n&quot;</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">...</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>But what are we going to replace the <code>...</code> with? What we need is some way to await the content of both of the REST API calls we&#39;re fetching and <i>then</i> do something. The easiest way to do this is to use Mojolicious&#39; implementation of promises: <a href="https://metacpan.org/module/Mojo::Promise">Mojo::Promise</a>.</p>

<p>When we write our <code>perform_search</code> function rather than waiting on the API call and only then returning from the function we instead immediately return a new <i>promise</i> object, a promise to later return the API data.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">perform_search</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$animal</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br /><span class="comment">    # create a new promise to return<br /></span>    <span class="keyword">my</span> <span class="symbol">$promise</span> <span class="operator">=</span> <span class="word">Mojo::Promise</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$ua</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Mojo::URL</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="single">'https://api.imgur.com'</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">path</span><span class="structure">(</span><span class="single">'/3/gallery/search'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">query</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">q_all</span> <span class="operator">=&gt;</span> <span class="double">&quot;christmas $animal&quot;</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">q_not</span> <span class="operator">=&gt;</span> <span class="single">'tag:&quot;secret santa&quot;'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">{</span> <span class="word">Authorization</span> <span class="operator">=&gt;</span> <span class="double">&quot;Client-ID $CLIENT_ID&quot;</span><span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$ua</span><span class="operator">,</span> <span class="symbol">$tx</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="word">STDERR</span> <span class="double">&quot;Got data back for $animal...\n&quot;</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$data</span> <span class="operator">=</span> <span class="symbol">$tx</span><span class="operator">-&gt;</span><span class="word">result</span><span class="operator">-&gt;</span><span class="word">json</span><span class="structure">(</span><span class="single">'/data'</span><span class="structure">);</span><br /><br /><span class="comment">            # resolve the promise with the data now we have it<br /></span>            <span class="symbol">$promise</span><span class="operator">-&gt;</span><span class="word">resolve</span><span class="structure">(</span> <span class="symbol">$data</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><br /><span class="comment">    # immediately return the promise object<br /></span>    <span class="keyword">return</span> <span class="symbol">$promise</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>When the callback is executed it calls the <code>resolve</code> method on the promise meaning anything waiting on that promise will be allowed to continue. For example:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$promise</span> <span class="operator">=</span> <span class="word">perform_search</span><span class="structure">(</span><span class="single">'cat'</span><span class="structure">);</span><br /><span class="symbol">$promise</span><span class="operator">-&gt;</span><span class="word">wait</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p><code>wait</code> runs the Mojolicious IO loop and halts the current execution flow until the promise is fulfilled or fails. In our example this happens when <code>resolve</code> is called by the <code>get</code> method&#39;s callback when the REST API response arrives - meaning <code>wait</code> in this example effectively stops the program until the API result has been downloaded.</p>

<p>Great! So how do we collect the promised result? The easiest way to do this is to use the <code>then</code> method on the promise. You can pass an anonymous subroutine to <code>then</code> which will be executed when that promise is resolved with whatever value was used to resolve it. Here&#39;s the really clever bit though: when called <code>then</code> itself immediately returns a new promise. This new promise will only get itself resolved when whatever happens in the anonymous subroutine is done.</p>

<p>If we want to capture our cat data structure we could use a <code>then</code>/<code>wait</code> pair like so:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$cat_results</span><span class="structure">;</span><br /><span class="word">perform_search</span><span class="structure">(</span><span class="single">'cat'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">(</span><span class="symbol">$cat_results</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span class="structure">;</span><br /><span class="structure">})</span><span class="operator">-&gt;</span><span class="word">wait</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>The anonymous subroutine is called when the promise that <code>perform_search</code> created is resolved (when the API request has returned). When that anonymous subroutine returns the promise that <code>then</code> created which we&#39;re waiting on is resolved. By creating this chain we&#39;re able to control the program flow.</p>

<p>Above I mentioned that the promise that <code>then</code> returns is resolved when the subroutine is done...but what did I mean by that? It&#39;s not <i>just</i> whenever the subroutine returns a value. The really really clever bit is that this occurs <i>either</i> when the anonymous subroutine returns a non promise value <i>or</i> it returns a promise that itself resolves! For example, we could return a promise for the dog API call in the first <code>then</code> subroutine and then the promise created will only allow us to move onto the next <code>then</code> when the dog search API promise is resolved. This sounds complicated, but actually is very readable in code:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$cat_results</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$dog_results</span><span class="structure">;</span><br /><br /><span class="word">perform_search</span><span class="structure">(</span><span class="single">'cat'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">(</span><span class="symbol">$cat_results</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">perform_search</span><span class="structure">(</span><span class="single">'dog'</span><span class="structure">);</span><br /><span class="structure">})</span><span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">(</span><span class="symbol">$dog_results</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><br /><span class="structure">})</span><span class="operator">-&gt;</span><span class="word">wait</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Before we continue onto running these requests in parallel we should do a little housekeeping. Mojo::UserAgent is actually able to create promises directly with the <code>get_p</code> convenience method. Now we know how to use <code>then</code> we can simplify our <code>perform_search</code> function greatly by chaining our promises within <code>perform_search</code>:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">perform_search</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$animal</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$ua</span><span class="operator">-&gt;</span><span class="word">get_p</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Mojo::URL</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="single">'https://api.imgur.com'</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">path</span><span class="structure">(</span><span class="single">'/3/gallery/search'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">query</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">q_all</span> <span class="operator">=&gt;</span> <span class="double">&quot;christmas $animal&quot;</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">q_not</span> <span class="operator">=&gt;</span> <span class="single">'tag:&quot;secret santa&quot;'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">{</span> <span class="word">Authorization</span> <span class="operator">=&gt;</span> <span class="double">&quot;Client-ID $CLIENT_ID&quot;</span><span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$tx</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$tx</span><span class="operator">-&gt;</span><span class="word">result</span><span class="operator">-&gt;</span><span class="word">json</span><span class="structure">(</span><span class="single">'/data'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>We&#39;re almost there! Now can we finally run these in parallel? You bet! There&#39;s no reason we have to pause for the cat promise to complete before retrieving the dog promise:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$cat_results</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$dog_results</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$promise1</span> <span class="operator">=</span> <span class="word">perform_search</span><span class="structure">(</span><span class="single">'cat'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span> <span class="symbol">$cat_results</span> <span class="operator">=</span> <span class="core">shift</span> <span class="structure">});</span><br /><span class="keyword">my</span> <span class="symbol">$promise2</span> <span class="operator">=</span> <span class="word">perform_search</span><span class="structure">(</span><span class="single">'dog'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span> <span class="symbol">$dog_results</span> <span class="operator">=</span> <span class="core">shift</span> <span class="structure">});</span><br /><span class="symbol">$promise1</span><span class="operator">-&gt;</span><span class="word">wait</span><span class="structure">;</span><br /><span class="symbol">$promise2</span><span class="operator">-&gt;</span><span class="word">wait</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Data::Dumper</span><span class="structure">;</span><br /><span class="word">print</span> <span class="word">Dumper</span> <span class="structure">[</span><span class="symbol">$cat_results</span><span class="operator">,</span> <span class="symbol">$dog_results</span><span class="structure">];</span></code><br />&nbsp;</td></table>

<p>Looking good! Mojo::Promise&#39;s <code>all</code> method makes this even easier, allowing us to quickly create a single promise that will resolve when all the promises we pass to it themselves resolve:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$cat_results</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$dog_results</span><span class="structure">;</span><br /><span class="word">Mojo::Promise</span><span class="operator">-&gt;</span><span class="word">all</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">perform_search</span><span class="structure">(</span><span class="single">'cat'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span> <span class="symbol">$cat_results</span> <span class="operator">=</span> <span class="core">shift</span> <span class="structure">})</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">perform_search</span><span class="structure">(</span><span class="single">'dog'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span> <span class="symbol">$dog_results</span> <span class="operator">=</span> <span class="core">shift</span> <span class="structure">})</span><span class="operator">,</span><br /><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">wait</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Or, even more simply necessitating only writing one <code>then</code> call:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$cat_results</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$dog_results</span><span class="structure">;</span><br /><span class="word">Mojo::Promise</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">all</span><span class="structure">(</span> <span class="word">perform_search</span><span class="structure">(</span><span class="single">'cat'</span><span class="structure">)</span><span class="operator">,</span> <span class="word">perform_search</span><span class="structure">(</span><span class="single">'dog'</span><span class="structure">)</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="structure">(</span><span class="symbol">$cat_results</span><span class="operator">,</span> <span class="symbol">$dog_results</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span> <span class="structure">}</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">wait</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Now all that&#39;s left to do is zip the results together so we get alternating cat and dog posts (we can even use the same template code we had before):</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">List::MoreUtils</span> <span class="words">qw(zip)</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$results</span> <span class="operator">=</span> <span class="structure">[</span> <span class="word">zip</span> <span class="cast">@</span><span class="structure">{</span> <span class="symbol">$cat_results</span> <span class="structure">}</span><span class="operator">,</span> <span class="cast">@</span><span class="structure">{</span> <span class="symbol">$dog_results</span> <span class="structure">}</span> <span class="structure">];</span><br /><br /><span class="keyword">my</span> <span class="symbol">$mt</span> <span class="operator">=</span> <span class="word">Mojo::Template</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">;</span><br /><span class="word">print</span> <span class="symbol">$mt</span><span class="operator">-&gt;</span><span class="word">vars</span><span class="structure">(</span><span class="number">1</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">render</span><span class="structure">(</span><span class="heredoc">&lt;&lt;'HTML'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">data</span> <span class="operator">=&gt;</span> <span class="symbol">$results</span> <span class="structure">});</span><br /><span class="heredoc_content">&lt;html&gt;<br />&lt;body&gt;<br />% for my $post (@{ $data }) {<br />&lt;h2&gt;&lt;%= $post-&gt;{title} %&gt;&lt;/h2&gt;<br />%   for my $image (@{ $post-&gt;{images} }) {<br />&lt;img src=&quot;&lt;%= $image-&gt;{link} %&gt;&quot; width=&quot;400&quot;&gt;<br />&lt;p&gt;&lt;%= $image-&gt;{description} || &quot;&quot;%&gt;&lt;/p&gt;<br />%   }<br />% }<br />&lt;/body&gt;<br />&lt;/html&gt;<br /></span><span class="heredoc_terminator">HTML<br /></span></code><br />&nbsp;</td></table>

<p>And there, as promised (groan) is our Christmas Cat and Dog Extravaganza.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Test/Compare Your Excel" href="2018-12-18.html">Previous</a></li>

    <li class="next"><a title="Christmas-iSH" href="2018-12-20.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-27056407-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>





