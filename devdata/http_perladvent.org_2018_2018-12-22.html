<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.113" />
    <link rel="alternate" title="Perl Advent Calendar 2018 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2018.css" type="text/css" />
    <title>
Perl Advent Calendar 2018 - 
Validation

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2018</a></h1>
        </div>

        <p id="tagline">2018 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Validation</h1>
<div class='subtitle'>Method::ParamValidator - 2018-12-22</div>

<div class='pod'><p>Today I want to talk about <a href="https://metacpan.org/module/Method::ParamValidator">Method::ParamValidator</a> - yet another validator for method parameters.</p>

<p>Why another validator? I was looking for param validators that can be shared among various Google API interfaces that I have worked on. None of the existing solutions worked for me. So I decided to create simple, yet easily configurable, param validator. The best part of this solution is that you can add the param validation programmatically as well as in a configuration file.</p>

<p>I think the Christmas Elves would find this flexibility really useful when working on Santa&#39;s codebase.</p>

<h3 id="Configuring-Validation">Configuring Validation</h3>

<p>There are two core methods <code>add_field()</code> and <code>add_method()</code> that can be used to setup a LMethod::ParamValidator validator.</p>

<h4 id="add_field-params">add_field(\%params)</h4>

<p>First step in creating a validator is to add the fields that can be shared by one or many methods in a validator. You can provide the following keys to add new field.</p>

<p><table border=1 frame=void rules=rows> <tr> <td><b>name</b></td> <td>unique field name (required).</td> </tr> <tr> <td><b>format</b></td> <td>data type of the field (optional), possible values are 's' (for string) and 'd' (for digits). Default is 's'.</td> </tr> <tr> <td><b>check</b></td> <td>code ref for custom check of the field (optional).</td> </tr> <tr> <td><b>source</b></td> <td>lookup hashref for the acceptable values for the field (optional).</td> </tr> <tr> <td><b>message</b></td> <td>test message (optional).</td> </tr> </table>

</p>



<h4 id="add_method-params">add_method(\%params)</h4>

<p>After adding fields to the validator, it is time to add method to be validated. You can setup method by providing the following keys.</p>

<p><table border=1 frame=void rules=rows> <tr><td><b>name</b></td><td>unique method name (required).</td></td> <tr><td><b>fields<b></td><td>hashref with field names.</td></tr> </table>

</p>



<h3 id="Example">Example</h3>

<p>Suppose our elves want to validate the parameters for a method called <code>add_child()</code>. It requires parameters passed as a hashref with required keys <code>firstname</code>, <code>lastname</code> and <code>age</code> and it also accepts an optional key <code>notes</code> as well. We will first add all the fields first and then we will add the method the method that uses these fields.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Method::ParamValidator</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$validator</span> <span class="operator">=</span> <span class="word">Method::ParamValidator</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">;</span><br /><br /><span class="comment"># Add fields<br /></span><span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">add_field</span><span class="structure">({</span> <span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'firstname'</span><span class="operator">,</span> <span class="word">format</span> <span class="operator">=&gt;</span> <span class="single">'s'</span> <span class="structure">});</span><br /><span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">add_field</span><span class="structure">({</span> <span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'lastname'</span><span class="operator">,</span>  <span class="word">format</span> <span class="operator">=&gt;</span> <span class="single">'s'</span> <span class="structure">});</span><br /><span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">add_field</span><span class="structure">({</span> <span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'age'</span><span class="operator">,</span>       <span class="word">format</span> <span class="operator">=&gt;</span> <span class="single">'d'</span> <span class="structure">});</span><br /><span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">add_field</span><span class="structure">({</span> <span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'notes'</span><span class="operator">,</span>     <span class="word">format</span> <span class="operator">=&gt;</span> <span class="single">'s'</span> <span class="structure">});</span><br /><br /><span class="comment"># Add method<br /></span><span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">add_method</span><span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'add_child'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">fields</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">firstname</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">lastname</span>  <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">age</span>       <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">notes</span>     <span class="operator">=&gt;</span> <span class="number">0</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><span class="structure">});</span></code><br />&nbsp;</td></table>

<p>We can alternatively setup the validator using a configuration file. If we wanted the same checks as above we could create a JSON file like so:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synIdentifier">{</span> <span class="synConstant">&quot;fields&quot;</span>  : <span class="synIdentifier">[</span> <span class="synIdentifier">{</span> <span class="synConstant">&quot;name&quot;</span> : <span class="synConstant">&quot;firstname&quot;</span>, <span class="synConstant">&quot;format&quot;</span> : <span class="synConstant">&quot;s&quot;</span> <span class="synIdentifier">}</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">{</span> <span class="synConstant">&quot;name&quot;</span> : <span class="synConstant">&quot;lastname&quot;</span>,  <span class="synConstant">&quot;format&quot;</span> : <span class="synConstant">&quot;s&quot;</span> <span class="synIdentifier">}</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">{</span> <span class="synConstant">&quot;name&quot;</span> : <span class="synConstant">&quot;age&quot;</span>,       <span class="synConstant">&quot;format&quot;</span> : <span class="synConstant">&quot;d&quot;</span> <span class="synIdentifier">}</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">{</span> <span class="synConstant">&quot;name&quot;</span> : <span class="synConstant">&quot;notes&quot;</span>,     <span class="synConstant">&quot;format&quot;</span> : <span class="synConstant">&quot;s&quot;</span> <span class="synIdentifier">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">]</span>,<br />&nbsp;&nbsp;<span class="synConstant">&quot;methods&quot;</span> : <span class="synIdentifier">[</span> <span class="synIdentifier">{</span> <span class="synConstant">&quot;name&quot;</span>  : <span class="synConstant">&quot;add_child&quot;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">&quot;fields&quot;</span>: <span class="synIdentifier">{</span> <span class="synConstant">&quot;firstname&quot;</span> : <span class="synConstant">&quot;1&quot;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">&quot;lastname&quot;</span>  : <span class="synConstant">&quot;1&quot;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">&quot;age&quot;</span>       : <span class="synConstant">&quot;1&quot;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">&quot;notes&quot;</span>     : <span class="synConstant">&quot;0&quot;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">]</span><br /><span class="synIdentifier">}</span></code><br />&nbsp;</td></table>

<p>And now when we instanciate our Method::ParamValidator instance we can simply pass in the name of the configuraton file <code>config.json</code>.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Method::ParamValidator</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$validator</span> <span class="operator">=</span> <span class="word">Method::ParamValidator</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">({</span> <span class="word">config</span> <span class="operator">=&gt;</span> <span class="double">&quot;config.json&quot;</span> <span class="structure">});</span></code><br />&nbsp;</td></table>

<h3 id="Using-Our-Validator">Using Our Validator</h3>

<p>Our validator is very simple to use; A call to <code>validate</code> passing in the method name and the parameters will simply throw an exception if the validation fails. We can either let these exceptions terminate our program, or we can catch them using Perl&#39;s exception handling (for example with <a href="https://metacpan.org/module/Try::Tiny">Try::Tiny</a>&#39;s <code>try</code>/<code>catch</code> blocks or even with the inbuilt <code>eval</code> keyword.)</p>

<p>Let&#39;s demonstrate what kind of error messages the elves are going to get with a test suite. <a href="https://metacpan.org/module/Test::Exception">Test::Exception</a> expects an exception to be thrown inside a <code>throws_ok</code> block and conversely fails if one is thrown inside a <code>lives_ok</code> block.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Test::More</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Test::Exception</span><span class="structure">;</span><br /><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'get_xyz'</span><span class="structure">)</span>  <span class="structure">}</span> <span class="regexp">qr/Invalid method name received/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'add_child'</span><span class="structure">)</span> <span class="structure">}</span> <span class="regexp">qr/Missing parameters/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'add_child'</span><span class="operator">,</span> <span class="structure">[])</span> <span class="structure">}</span> <span class="regexp">qr/Invalid parameters data structure/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'add_child'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">firstname</span> <span class="operator">=&gt;</span> <span class="single">'F'</span><span class="operator">,</span> <span class="word">lastname</span> <span class="operator">=&gt;</span> <span class="single">'L'</span><span class="operator">,</span> <span class="word">age</span> <span class="operator">=&gt;</span> <span class="single">'A'</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Parameter failed check constraint/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'add_child'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">firstname</span> <span class="operator">=&gt;</span> <span class="single">'F'</span><span class="operator">,</span> <span class="word">lastname</span> <span class="operator">=&gt;</span> <span class="single">'L'</span><span class="operator">,</span> <span class="word">age</span> <span class="operator">=&gt;</span> <span class="number">10</span><span class="operator">,</span> <span class="word">notes</span> <span class="operator">=&gt;</span> <span class="single">'s'</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Parameter failed check constraint/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'add_child'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">firstname</span> <span class="operator">=&gt;</span> <span class="single">'F'</span><span class="operator">,</span> <span class="word">lastname</span> <span class="operator">=&gt;</span> <span class="single">'L'</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Missing required parameter/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'add_child'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">firstname</span> <span class="operator">=&gt;</span> <span class="single">'F'</span><span class="operator">,</span> <span class="word">lastname</span> <span class="operator">=&gt;</span> <span class="core">undef</span><span class="operator">,</span> <span class="word">age</span> <span class="operator">=&gt;</span> <span class="number">10</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Undefined required parameter/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'add_child'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">firstname</span> <span class="operator">=&gt;</span> <span class="single">'F'</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Missing required parameter/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'add_child'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">firstname</span> <span class="operator">=&gt;</span> <span class="single">'F'</span><span class="operator">,</span> <span class="word">lastname</span> <span class="operator">=&gt;</span> <span class="single">'L'</span><span class="operator">,</span> <span class="word">age</span> <span class="operator">=&gt;</span> <span class="number">40</span><span class="operator">,</span> <span class="word">location</span> <span class="operator">=&gt;</span> <span class="single">'X'</span> <span class="structure">})</span>  <span class="structure">}</span> <span class="regexp">qr/Parameter failed check constraint/</span><span class="structure">;</span><br /><span class="word">lives_ok</span>  <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'add_child'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">firstname</span> <span class="operator">=&gt;</span> <span class="single">'F'</span><span class="operator">,</span> <span class="word">lastname</span> <span class="operator">=&gt;</span> <span class="single">'L'</span><span class="operator">,</span> <span class="word">age</span> <span class="operator">=&gt;</span> <span class="number">40</span><span class="operator">,</span> <span class="word">location</span> <span class="operator">=&gt;</span> <span class="single">'UK'</span> <span class="structure">})</span> <span class="structure">};</span><br /><span class="word">lives_ok</span>  <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'add_child'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">firstname</span> <span class="operator">=&gt;</span> <span class="single">'F'</span><span class="operator">,</span> <span class="word">lastname</span> <span class="operator">=&gt;</span> <span class="single">'L'</span><span class="operator">,</span> <span class="word">age</span> <span class="operator">=&gt;</span> <span class="number">40</span><span class="operator">,</span> <span class="word">location</span> <span class="operator">=&gt;</span> <span class="single">'uk'</span> <span class="structure">})</span> <span class="structure">};</span><br /><br /><span class="word">done_testing</span><span class="structure">();</span></code><br />&nbsp;</td></table>

<h3 id="Custom-Checks">Custom Checks</h3>

<p>Up until this point we&#39;ve used very simple inbuilt checks: Is this a string? Is this digits? Are the required parameters passed? But what if we want to define something more complicated?</p>

<p>When adding field to a validator, you can hookup your own checks. Below we are adding new field <code>location</code> with a custom check</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$LOCATION</span> <span class="operator">=</span> <span class="structure">{</span> <span class="single">'USA'</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span> <span class="single">'UK'</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">};</span><br /><br /><span class="comment"># Add field with custom check<br /></span><span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">add_field</span><span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span>   <span class="operator">=&gt;</span> <span class="single">'location'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">format</span> <span class="operator">=&gt;</span> <span class="single">'s'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">check</span>  <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">exists</span> <span class="symbol">$LOCATION</span><span class="operator">-&gt;</span><span class="structure">{</span> <span class="word">uc</span><span class="structure">(</span><span class="magic">$_</span><span class="structure">[</span><span class="number">0</span><span class="structure">])</span> <span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br /><span class="structure">});</span><br /><br /><span class="comment"># Add method using the new field with custom check<br /></span><span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">add_method</span><span class="structure">({</span> <span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'check_location'</span><span class="operator">,</span> <span class="word">fields</span> <span class="operator">=&gt;</span> <span class="structure">{</span> <span class="word">location</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">}});</span></code><br />&nbsp;</td></table>

<p>While we can&#39;t create custom Perl code in our configuration file we can create a limited custom check as above:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synIdentifier">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">&quot;fields&quot;</span>  : <span class="synIdentifier">[{</span> <span class="synConstant">&quot;name&quot;</span> : <span class="synConstant">&quot;location&quot;</span>, <span class="synConstant">&quot;format&quot;</span> : <span class="synConstant">&quot;s&quot;</span>, <span class="synConstant">&quot;source&quot;</span>: <span class="synIdentifier">[</span> <span class="synConstant">&quot;USA&quot;</span>, <span class="synConstant">&quot;UK&quot;</span> <span class="synIdentifier">]</span> <span class="synIdentifier">}</span> <span class="synIdentifier">]</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">&quot;methods&quot;</span> : <span class="synIdentifier">[{</span> <span class="synConstant">&quot;name&quot;</span> : <span class="synConstant">&quot;check_location&quot;</span>, <span class="synConstant">&quot;fields&quot;</span>: <span class="synIdentifier">{</span> <span class="synConstant">&quot;location&quot;</span> : <span class="synConstant">&quot;1&quot;</span> <span class="synIdentifier">}</span> <span class="synIdentifier">}</span> <span class="synIdentifier">]</span><br /><span class="synIdentifier">}</span></code><br />&nbsp;</td></table>

<p>The array under the <code>source</code> key lists all the values that the <code>location</code> field can have whenever the value is uppercased.</p>

<p>We can demonstrate what kind of error messages our elves are going to see with another test script:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Test::More</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Test::Exception</span><span class="structure">;</span><br /><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="single">'check_location'</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">location</span> <span class="operator">=&gt;</span> <span class="single">'X'</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Parameter failed check constraint/</span><span class="structure">;</span><br /><span class="word">done_testing</span><span class="structure">();</span></code><br />&nbsp;</td></table>

<h3 id="Extend-Moo-Package">Extend Moo Package</h3>

<p>So we&#39;ve seen how we can call the validation up manually, but is there an easy way to add it to multiple methods in a class without having to change the method code?</p>

<p>If you want to plug the validator into an existing <code>Moo</code> package it&#39;s easy. For an example let&#39;s create package <code>Calculator</code>.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Calculator</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Moo</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">calc</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="operator">,</span> <span class="symbol">$param</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span><span class="symbol">$param</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">op</span><span class="structure">}</span> <span class="operator">eq</span> <span class="single">'add'</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="structure">(</span><span class="symbol">$param</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">a</span><span class="structure">}</span> <span class="operator">+</span> <span class="symbol">$param</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">b</span><span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">elsif</span> <span class="structure">(</span><span class="symbol">$param</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">op</span><span class="structure">}</span> <span class="operator">eq</span> <span class="single">'sub'</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="structure">(</span><span class="symbol">$param</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">a</span><span class="structure">}</span> <span class="operator">-</span> <span class="symbol">$param</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">b</span><span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">elsif</span> <span class="structure">(</span><span class="symbol">$param</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">op</span><span class="structure">}</span> <span class="operator">eq</span> <span class="single">'mul'</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="structure">(</span><span class="symbol">$param</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">a</span><span class="structure">}</span> <span class="operator">*</span> <span class="symbol">$param</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">b</span><span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Now it is time to create configuration file <code>calc.json</code> for validator.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synIdentifier">{</span> <span class="synConstant">&quot;fields&quot;</span>  : <span class="synIdentifier">[</span> <span class="synIdentifier">{</span> <span class="synConstant">&quot;name&quot;</span> : <span class="synConstant">&quot;op&quot;</span>, <span class="synConstant">&quot;format&quot;</span> : <span class="synConstant">&quot;s&quot;</span>, <span class="synConstant">&quot;source&quot;</span>: <span class="synIdentifier">[</span> <span class="synConstant">&quot;add&quot;</span>, <span class="synConstant">&quot;sub&quot;</span>, <span class="synConstant">&quot;mul&quot;</span> <span class="synIdentifier">]</span> <span class="synIdentifier">}</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">{</span> <span class="synConstant">&quot;name&quot;</span> : <span class="synConstant">&quot;a&quot;</span>,  <span class="synConstant">&quot;format&quot;</span> : <span class="synConstant">&quot;d&quot;</span> <span class="synIdentifier">}</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">{</span> <span class="synConstant">&quot;name&quot;</span> : <span class="synConstant">&quot;b&quot;</span>,  <span class="synConstant">&quot;format&quot;</span> : <span class="synConstant">&quot;d&quot;</span> <span class="synIdentifier">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">]</span>,<br />&nbsp;&nbsp;<span class="synConstant">&quot;methods&quot;</span> : <span class="synIdentifier">[</span> <span class="synIdentifier">{</span> <span class="synConstant">&quot;name&quot;</span>  : <span class="synConstant">&quot;calc&quot;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">&quot;fields&quot;</span>: <span class="synIdentifier">{</span> <span class="synConstant">&quot;op&quot;</span> : <span class="synConstant">&quot;1&quot;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">&quot;a&quot;</span>  : <span class="synConstant">&quot;1&quot;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">&quot;b&quot;</span>  : <span class="synConstant">&quot;1&quot;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">]</span><br /><span class="synIdentifier">}</span></code><br />&nbsp;</td></table>

<p>Add the following lines to plug the validator.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Method::ParamValidator</span><span class="structure">;</span><br /><br /><span class="word">has</span> <span class="single">'validator'</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span>      <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">default</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="word">Method::ParamValidator</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">config</span> <span class="operator">=&gt;</span> <span class="double">&quot;calc.json&quot;</span><span class="structure">)</span> <span class="structure">}</span><br /><span class="structure">);</span><br /><br /><span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$method</span> <span class="structure">(</span><span class="words">qw/calc/</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">before</span> <span class="symbol">$method</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="operator">,</span> <span class="symbol">$param</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">validator</span><span class="operator">-&gt;</span><span class="word">validate</span><span class="structure">(</span><span class="symbol">$method</span><span class="operator">,</span> <span class="symbol">$param</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>For the love of TDD, lets define the unit test.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Test::More</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Test::Exception</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Calculator</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$calc</span> <span class="operator">=</span> <span class="word">Calculator</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">;</span><br /><br /><span class="word">is</span><span class="structure">(</span><span class="symbol">$calc</span><span class="operator">-&gt;</span><span class="word">calc</span><span class="structure">({</span> <span class="word">op</span> <span class="operator">=&gt;</span> <span class="single">'add'</span><span class="operator">,</span> <span class="word">a</span> <span class="operator">=&gt;</span> <span class="number">4</span><span class="operator">,</span> <span class="word">b</span> <span class="operator">=&gt;</span> <span class="number">2</span> <span class="structure">})</span><span class="operator">,</span> <span class="number">6</span><span class="structure">);</span><br /><span class="word">is</span><span class="structure">(</span><span class="symbol">$calc</span><span class="operator">-&gt;</span><span class="word">calc</span><span class="structure">({</span> <span class="word">op</span> <span class="operator">=&gt;</span> <span class="single">'sub'</span><span class="operator">,</span> <span class="word">a</span> <span class="operator">=&gt;</span> <span class="number">4</span><span class="operator">,</span> <span class="word">b</span> <span class="operator">=&gt;</span> <span class="number">2</span> <span class="structure">})</span><span class="operator">,</span> <span class="number">2</span><span class="structure">);</span><br /><span class="word">is</span><span class="structure">(</span><span class="symbol">$calc</span><span class="operator">-&gt;</span><span class="word">calc</span><span class="structure">({</span> <span class="word">op</span> <span class="operator">=&gt;</span> <span class="single">'mul'</span><span class="operator">,</span> <span class="word">a</span> <span class="operator">=&gt;</span> <span class="number">4</span><span class="operator">,</span> <span class="word">b</span> <span class="operator">=&gt;</span> <span class="number">2</span> <span class="structure">})</span><span class="operator">,</span> <span class="number">8</span><span class="structure">);</span><br /><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$calc</span><span class="operator">-&gt;</span><span class="word">calc</span><span class="structure">({</span> <span class="word">op</span> <span class="operator">=&gt;</span> <span class="single">'add'</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Missing required parameter. \(a\)/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$calc</span><span class="operator">-&gt;</span><span class="word">calc</span><span class="structure">({</span> <span class="word">op</span> <span class="operator">=&gt;</span> <span class="single">'add'</span><span class="operator">,</span> <span class="word">a</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Missing required parameter. \(b\)/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$calc</span><span class="operator">-&gt;</span><span class="word">calc</span><span class="structure">({</span> <span class="word">op</span> <span class="operator">=&gt;</span> <span class="single">'x'</span><span class="operator">,</span> <span class="word">a</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span> <span class="word">b</span> <span class="operator">=&gt;</span> <span class="number">2</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Parameter failed check constraint. \(op\)/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$calc</span><span class="operator">-&gt;</span><span class="word">calc</span><span class="structure">({</span> <span class="word">op</span> <span class="operator">=&gt;</span> <span class="single">'add'</span><span class="operator">,</span> <span class="word">a</span> <span class="operator">=&gt;</span> <span class="single">'x'</span><span class="operator">,</span> <span class="word">b</span> <span class="operator">=&gt;</span> <span class="number">2</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Parameter failed check constraint. \(a\)/</span><span class="structure">;</span><br /><span class="word">throws_ok</span> <span class="structure">{</span> <span class="symbol">$calc</span><span class="operator">-&gt;</span><span class="word">calc</span><span class="structure">({</span> <span class="word">op</span> <span class="operator">=&gt;</span> <span class="single">'add'</span><span class="operator">,</span> <span class="word">a</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span> <span class="word">b</span> <span class="operator">=&gt;</span> <span class="single">'x'</span> <span class="structure">})</span> <span class="structure">}</span> <span class="regexp">qr/Parameter failed check constraint. \(b\)/</span><span class="structure">;</span><br /><br /><span class="word">done_testing</span><span class="structure">();</span></code><br />&nbsp;</td></table>

<h3 id="Conclusion">Conclusion</h3>

<p>I have used <a href="https://metacpan.org/module/Method::ParamValidator">Method::ParamValidator</a> to one of my Google API interface <a href="https://metacpan.org/module/WWW::Google::Places">WWW::Google::Places</a>. Any help to extend the validator would be highly appreciated. Or if you have any suggestions please raise them at <a href="https://github.com/manwar/Method-ParamValidator">GitHub</a>.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/4fb4fc280d9afbfeeec8142f813c4ecf?r=g&s=80&d=retro />
This article contributed by: Mohammad S Anwar &lt;mohammad.anwar@yahoo.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Debug Hard" href="2018-12-21.html">Previous</a></li>

    <li class="next"><a title="Legacy code strikes again" href="2018-12-23.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-27056407-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>





